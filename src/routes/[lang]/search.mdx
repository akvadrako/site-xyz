---
title_en: Search
layout: null
noindex: true
---
<script>
    import {page} from '$app/stores'
    import {search} from '$lib/search'
    import {prerendering} from '$app/env'
    import {SmallPhoto} from '$comp'

    export const title = 'search'

    $: query = $page.url.searchParams.get('q')
    
    $: ahits = prerendering ? [] : search(query)

    function findMarks(field, term) {
        let pat = new RegExp(term, 'gi')
        let matches = field.matchAll(pat)
        let marks = []

        for(let match of matches) {
            marks.push([match.index, match[0].length])
        }

        return marks
    }

    // field: str content (path, body, title, etc...)
    // marks: [[start, length], ...]
    function highlight(field, term) {
        let marks = findMarks(field, term)

        try {
            let out = ''
            for(let pair of marks) {
                let begin = Math.max(pair[0] - 10, 0)
                let sub = [pair[0], pair[0] + pair[1]]
                let end = Math.min(sub[1] + 10, field.length)
            
                if(out)
                    out += '<br/>'

                out += '' // `${pair} `
                    + field.substring(begin, sub[0])
                    + '<mark>'
                    + field.substring(sub[0], sub[1])
                    + '</mark>'
                    + field.substring(sub[1], end)
            }
            return out;
        } catch(e) {
            return `error: ${e}`
        }
    }
</script>

<style>
    .side :global(img) {
        height: 100%;
        width: 100%;
        position: absolute;
        object-fit: cover;
    }
    .side {
        width: 10em;
        position: relative;
    }
</style>

{#await ahits}
    <div>...loading...</div>
{:then hits}
    <h2>Search results for {query} ({hits.length})</h2>

    {#each hits as hit}
        <a href={hit.path}>
        <div class="flex justify-center w-full p-5">
            <div class="flex flex-col min-h-40 w-full md:flex-row md:max-w-2xl rounded-lg bg-white shadow-lg">
                <div class="side">
                    {#if hit.image}
                        <SmallPhoto src="{hit.image}" alt="{hit.title}" />
                    {/if}
                </div>
                <div class="p-6 flex flex-col justify-start">
                    <h5 class="text-gray-900 text-xl font-medium mb-2">{hit.title}</h5>
                    {#each Object.entries(hit.match) as [term, fields] }
                        {#each fields as field }
                            <p class="text-gray-700 text-base mb-2">
                                <b>{field}</b>: {@html highlight(hit[field], term)}
                            </p>
                        {/each}
                    {/each}
                    <p class="text-gray-600 text-xs">
                        {hit.layout || "page"}, relevance score {hit.score}
                    </p>
                </div>
            </div>
        </div>
        </a>
    {/each}
{:catch error}
    <div>...{error.message}</div>
{/await}
