---
title: Search
layout: null
---
<script>
    import {page} from '$app/stores'
    import { onMount, afterUpdate } from 'svelte'
    import {log, lang} from '$lib'
    import {Link} from '$comp'
    import {debounce} from 'lodash-es'
    import MiniSearch from 'minisearch'

    export const title = 'search'

    const data_href = '/data/search_index.json'

    let query = 'home'

    // update query when URL string changes
    let prev_param = null
    $: (() => {
        let q = $page.url.searchParams.get('q')
        if(prev_param != q) {
            prev_param = q
            query = q
            search()
        }
    })()

    let idx = null
    let hits = []
    let suggest = []
    
    onMount(async () => {
        
        console.log('loading', data_href)
        const res = await fetch(data_href)
        const data = await res.json()
        
        idx = MiniSearch.loadJS(data.index, data.config)
        console.log('loading done')
        search()
    })

    let search = debounce(
        () => {
            console.log('search', { idx: typeof idx })

            if(! idx)
                return
                    
            suggest = idx.autoSuggest(query)

            hits = idx.search(query, {
                prefix: true,
                boost: { title: 2, path: 2 },
                fuzzy: 0.2,
            })
        },
        300,
        {},
    )

    function findMarks(field, term) {
        let pat = new RegExp(term, 'gi')
        let matches = field.matchAll(pat)
        let marks = []

        for(let match of matches) {
            marks.push([match.index, match[0].length])
        }

        return marks
    }

    // field: str content (path, body, title, etc...)
    // marks: [[start, length], ...]
    function highlight(field, term) {
        let marks = findMarks(field, term)

        try {
            let out = ''
            for(let pair of marks) {
                let begin = Math.max(pair[0] - 10, 0)
                let sub = [pair[0], pair[0] + pair[1]]
                let end = Math.min(sub[1] + 10, field.length)
            
                if(out)
                    out += '<br/>'

                out += `${pair} `
                    + field.substring(begin, sub[0])
                    + '<mark>'
                    + field.substring(sub[0], sub[1])
                    + '</mark>'
                    + field.substring(sub[1], end)
            }
            return out;
        } catch(e) {
            return `error: ${e}`
        }
    }

</script>
<Link title='/search_index.json' ext={true} path='/search_index.json' />
<p>
    <!-- FIXME - live search not working -->
    <input
        type="text"
        placeholder="Type here to search"
        on:change={search}
        bind:value={query}
    />
    <input type="submit" value="search" on:click={search.flush} />
</p>

<h2>Suggestions</h2>

{JSON.stringify(suggest)}

<h2>{hits.length} hits</h2>

<table>
    <tr><th>ref</th><th>score</th><th>blurb</th></tr>
    {#each hits as hit}
    <tr>
        <td><a href={hit.path}>{hit.title}</a></td>
        <td>{hit.score}</td>
        <td>
        {#each Object.entries(hit.match) as [term, fields] }
            {#each fields as field }
                <b>{field}</b>: {@html highlight(hit[field], term)}
            {/each}
        {/each}
        </td>
    </tr>
    {/each}
</table>

